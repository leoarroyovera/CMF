<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Minutos de Retraso</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
            background-color: #f9f9f9;
        }
        h1, h2 {
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        input {
            padding: 5px;
            font-size: 16px;
            margin-bottom: 10px;
            width: 100%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #ccc;
        }
        th, td {
            padding: 10px;
            text-align: center;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gestor de Minutos de Retraso</h1>
        <h2>Calcula cómo distribuir tus minutos restantes</h2>
        <label for="minutos-adelantados">Minutos usados hasta ahora:</label>
        <input type="number" id="minutos-adelantados" placeholder="Ingresa minutos usados" />

        <label for="dias-habiles">Días hábiles restantes:</label>
        <input type="number" id="dias-habiles" placeholder="Ingresa días hábiles restantes" />

        <p id="resultado-inicial"></p>
        <p id="resultado-dinamico" class="success"></p>
        <div id="error-message" class="error"></div>
        <table>
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Minutos disponibles</th>
                    <th>Hora de ingreso</th>
                    <th>Hora de salida</th>
                </tr>
            </thead>
            <tbody id="dias-tabla">
            </tbody>
        </table>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const maxMinutos = 59;

            document.getElementById("minutos-adelantados").addEventListener("input", actualizarTabla);
            document.getElementById("dias-habiles").addEventListener("input", actualizarTabla);

            actualizarTabla();
        });

        function actualizarTabla() {
            const maxMinutos = 59;
            const minutosUsados = parseInt(document.getElementById("minutos-adelantados").value) || 0;
            const diasHabiles = parseInt(document.getElementById("dias-habiles").value) || 0;
            const minutosRestantes = maxMinutos - minutosUsados;

            const errorElement = document.getElementById("error-message");
            const resultadoInicial = document.getElementById("resultado-inicial");
            const resultadoDinamico = document.getElementById("resultado-dinamico");
            const tabla = document.getElementById("dias-tabla");

            if (minutosUsados > maxMinutos) {
                errorElement.textContent = "No puedes usar más de 59 minutos en total.";
                return;
            } else {
                errorElement.textContent = "";
            }

            if (diasHabiles === 0) {
                tabla.innerHTML = "";
                resultadoDinamico.textContent = "No hay días hábiles configurados.";
                return;
            }

            const minutosPorDia = Math.floor(minutosRestantes / diasHabiles);
            tabla.innerHTML = "";

            if (!resultadoInicial.textContent) {
                resultadoInicial.textContent = `En total, te quedan ${minutosRestantes} minutos para distribuir.`;
            }

            for (let i = 0; i < diasHabiles; i++) {
                const row = document.createElement("tr");
                const fechaCell = document.createElement("td");
                const minutosCell = document.createElement("td");
                const ingresoCell = document.createElement("td");
                const salidaCell = document.createElement("td");

                // Fecha simulada
                const fecha = new Date();
                fecha.setDate(fecha.getDate() + i);
                fechaCell.textContent = fecha.toISOString().split("T")[0];

                // Campo de minutos asignados
                const minutosInput = document.createElement("input");
                minutosInput.type = "number";
                minutosInput.value = minutosPorDia;
                minutosInput.min = 0;
                minutosInput.max = minutosPorDia;
                minutosInput.addEventListener("input", () => {
                    if (parseInt(minutosInput.value) > minutosPorDia) {
                        minutosInput.value = minutosPorDia;
                    }
                    validarMinutos(minutosRestantes);
                    actualizarSalida(row, minutosInput);
                });
                minutosCell.appendChild(minutosInput);

                // Campo de hora de ingreso
                const ingresoInput = document.createElement("input");
                ingresoInput.type = "time";
                ingresoInput.addEventListener("input", () => actualizarSalida(row, minutosInput));
                ingresoCell.appendChild(ingresoInput);

                // Campo de hora de salida (no editable)
                const salidaInput = document.createElement("input");
                salidaInput.type = "time";
                salidaInput.readOnly = true;
                salidaCell.appendChild(salidaInput);

                row.appendChild(fechaCell);
                row.appendChild(minutosCell);
                row.appendChild(ingresoCell);
                row.appendChild(salidaCell);
                tabla.appendChild(row);
            }

            validarMinutos(minutosRestantes);
        }

        function validarMinutos(minutosRestantes) {
            const inputs = Array.from(document.querySelectorAll("table input[type='number']"));
            const suma = inputs.reduce((total, input) => total + (parseInt(input.value) || 0), 0);
            const resultadoDinamico = document.getElementById("resultado-dinamico");

            const minutosDisponibles = minutosRestantes - suma;

            resultadoDinamico.textContent = `Te quedan ${Math.max(minutosDisponibles, 0)} minutos por distribuir.`;
        }

        function actualizarSalida(row, minutosInput) {
            const ingresoInput = row.querySelector("input[type='time']");
            const salidaInput = row.querySelector("input[type='time']:last-child");

            if (!ingresoInput.value) {
                salidaInput.value = "";
                return;
            }

            const minutosAsignados = parseInt(minutosInput.value) || 0;
            const [ingresoHora, ingresoMinuto] = ingresoInput.value.split(":").map(Number);

            const fecha = new Date(row.cells[0].textContent);
            const horasDeTrabajo = fecha.getDay() === 5 ? 8 : 9;

            let salidaHora = ingresoHora + horasDeTrabajo;
            let salidaMinuto = ingresoMinuto - minutosAsignados;

            if (salidaMinuto < 0) {
                salidaHora -= 1;
                salidaMinuto += 60;
            }

            salidaInput.value = `${String(salidaHora).padStart(2, "0")}:${String(salidaMinuto).padStart(2, "0")}`;
        }
    </script>
</body>
</html>
